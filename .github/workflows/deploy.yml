name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate secrets
        run: |
          if [ -z "${{ secrets.SERVER_HOST }}" ]; then
            echo "::error::SERVER_HOST secret is not set. Please add it in repository settings."
            exit 1
          fi
          if [ -z "${{ secrets.SERVER_USER }}" ]; then
            echo "::error::SERVER_USER secret is not set. Please add it in repository settings."
            exit 1
          fi
          if [ -z "${{ secrets.SERVER_SSH_KEY }}" ]; then
            echo "::error::SERVER_SSH_KEY secret is not set. Please add it in repository settings."
            exit 1
          fi
          echo "âœ… All required secrets are configured"

      - name: Deploy to server via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          script: |
            cd /var/www/calc1.ru
            git pull origin main
            docker compose down || docker-compose down
            docker compose build --no-cache || docker-compose build --no-cache
            docker compose up -d || docker-compose up -d
            docker system prune -f

            - name: Verify deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          script: |
            echo "ðŸ” Checking container status..."
            docker compose ps || docker-compose ps || true
            
            echo "â³ Waiting for application to start (90 seconds)..."
            sleep 90
            
            echo "ðŸ“‹ Checking container logs (last 100 lines)..."
            docker compose logs --tail=100 calc1 2>/dev/null || docker-compose logs --tail=100 calc1 2>/dev/null || true
            
            echo "ðŸŒ Checking if application is responding..."
            MAX_ATTEMPTS=20
            for i in $(seq 1 $MAX_ATTEMPTS); do
              if curl -f -s http://localhost:3000 > /dev/null 2>&1; then
                echo "âœ… Application is responding on port 3000!"
                exit 0
              fi
              echo "â³ Attempt $i/$MAX_ATTEMPTS: Application not ready yet, waiting 5 seconds..."
              sleep 5
            done
            
            echo "âŒ Application failed to start after $((MAX_ATTEMPTS * 5)) seconds"
            echo ""
            echo "ðŸ“‹ Final container status:"
            docker compose ps || docker-compose ps || true
            echo ""
            echo "ðŸ“‹ Container health:"
            docker inspect calc1-app --format='{{.State.Status}} - {{.State.Health.Status}}' 2>/dev/null || echo "Container not found"
            echo ""
            echo "ðŸ“‹ Last 200 lines of logs:"
            docker compose logs --tail=200 calc1 2>/dev/null || docker-compose logs --tail=200 calc1 2>/dev/null || true
            echo ""
            echo "ðŸ“‹ Checking if port 3000 is listening:"
            netstat -tuln | grep 3000 || ss -tuln | grep 3000 || echo "Port 3000 is not listening"
            echo ""
            echo "ðŸ“‹ Checking container processes:"
            docker top calc1-app 2>/dev/null || echo "Cannot check processes"
            exit 1

