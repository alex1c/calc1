# Алгоритм переноса калькуляторов из монолитного файла в категорийные

## Цель
Безопасно и полностью перенести переводы калькуляторов из `messages/ru.json` в категорийные файлы (например, `messages/ru/calculators/auto.json`) с гарантией полного сохранения всех данных.

## Проблема
При использовании deep-merge массивы заменяются полностью, а не объединяются. Если в новом файле массив короче, он полностью заменяет более длинный массив из монолитного файла.

## Алгоритм переноса

### Шаг 1: Подготовка
1. Создайте резервную копию монолитного файла:
   ```bash
   copy messages\ru.json messages\ru_backup.json
   ```

2. Убедитесь, что целевой категорийный файл существует (например, `messages/ru/calculators/auto.json`)

### Шаг 2: Извлечение полного блока калькулятора

1. Найдите блок калькулятора в монолитном файле:
   ```javascript
   calculators: {
     "calculator-name": { /* полный блок */ }
   }
   ```

2. Извлеките ВЕСЬ блок полностью, включая:
   - Все верхнеуровневые ключи (title, description, breadcrumbs, form, results, seo, hero, и т.д.)
   - Все вложенные объекты (seo.overview, seo.calculation, seo.faq и т.д.)
   - Все массивы полностью (faq.faqItems, overview.calculationExamples и т.д.)

### Шаг 3: Проверка структуры в старом файле

Перед копированием убедитесь, что понимаете структуру:
- Где находятся секции? (внутри `seo` или на верхнем уровне)
- Какие массивы присутствуют и сколько в них элементов?
- Есть ли вложенные объекты с несколькими уровнями?

### Шаг 4: Копирование в новый файл

1. Скопируйте ВЕСЬ блок калькулятора в категорийный файл:
   ```json
   {
     "calculators": {
       "calculator-name": {
         /* ВЕСЬ БЛОК ИЗ СТАРОГО ФАЙЛА БЕЗ ИЗМЕНЕНИЙ */
       }
     }
   }
   ```

2. Важно: Копируйте весь блок целиком, включая:
   - Все элементы массивов (не только первые несколько)
   - Все вложенные объекты
   - Правильную структуру (секции внутри seo, если так было в старом файле)

### Шаг 5: Проверка полноты переноса

Используйте скрипт проверки:
```bash
node scripts/check-migration.js
```

Скрипт проверяет:
- Количество FAQ элементов
- Количество примеров расчёта
- Соответствие верхнеуровневых ключей

### Шаг 6: Валидация на странице

1. Запустите приложение
2. Откройте страницу калькулятора
3. Проверьте, что все секции отображаются:
   - FAQ содержит все вопросы
   - Примеры расчёта присутствуют
   - Все секции SEO отображаются

### Шаг 7: Удаление из монолитного файла

Только после подтверждения, что всё работает:

1. Удалите блок калькулятора из `messages/ru.json`:
   ```json
   // Удалить:
   "calculator-name": {
     /* ... */
   },
   ```

2. Убедитесь, что JSON остался валидным:
   ```bash
   node -e "JSON.parse(require('fs').readFileSync('messages/ru.json', 'utf8')); console.log('OK')"
   ```

## Критические правила

### ❌ НЕЛЬЗЯ:
1. Копировать только часть массива (например, первые 9 из 40 FAQ элементов)
2. Менять структуру (перемещать секции между уровнями без проверки)
3. Пропускать вложенные объекты
4. Удалять из старого файла до проверки на странице

### ✅ ОБЯЗАТЕЛЬНО:
1. Копировать ВЕСЬ блок целиком со всеми вложениями
2. Проверять количество элементов в массивах
3. Сохранять структуру из старого файла
4. Использовать скрипт проверки перед удалением из монолита
5. Тестировать на странице после переноса

## Типичные ошибки и решения

### Ошибка: Массив заменён частично
**Симптом:** На странице отображается меньше элементов, чем должно быть  
**Причина:** В новый файл скопирован неполный массив, deep-merge заменил полный массив из монолита на короткий из нового файла  
**Решение:** Скопировать ВСЕ элементы массива из старого файла в новый

### Ошибка: Неправильная структура
**Симптом:** Секции не отображаются или отображаются в неправильном месте  
**Причина:** Изменена структура (например, `calculation` перемещён из `seo` на верхний уровень)  
**Решение:** Сохранить структуру точно такой, как в старом файле

### Ошибка: Отсутствуют вложенные объекты
**Симптом:** Некоторые секции пустые  
**Причина:** Не скопированы вложенные объекты  
**Решение:** Проверить все уровни вложенности и скопировать полностью

## Автоматизация

Для будущих переносов можно создать скрипт, который:
1. Извлекает полный блок калькулятора из монолита
2. Добавляет его в категорийный файл
3. Проверяет полноту переноса
4. Предлагает удалить из монолита (после подтверждения)

Пример использования:
```bash
node scripts/migrate-calculator.js calculator-name auto
```

## Проверочный чеклист

Перед удалением из монолитного файла убедитесь:
- [ ] Все FAQ элементы скопированы (проверено скриптом)
- [ ] Все примеры расчёта присутствуют (проверено скриптом)
- [ ] Структура идентична старому файлу (проверено скриптом)
- [ ] Страница калькулятора отображает все секции
- [ ] FAQ содержит все вопросы
- [ ] Примеры расчёта отображаются
- [ ] JSON файлы валидны

## Важные замечания

1. **Deep-merge заменяет массивы полностью** — если в новом файле массив короче, он заменит более длинный из монолита
2. **Структура должна быть идентична** — изменение структуры может сломать отображение
3. **Проверка обязательна** — всегда проверяйте на странице после переноса
4. **Не удаляйте из монолита сразу** — подождите подтверждения, что всё работает

