# Apache Virtual Host Configuration for calc1.ru
# Place this file in /etc/apache2/sites-available/calc1.ru.conf
# Then enable with: sudo a2ensite calc1.ru.conf

# HTTP Configuration (port 80) - Redirects to HTTPS
<VirtualHost *:80>
	ServerName calc1.ru
	ServerAlias www.calc1.ru

	# Redirect to HTTPS
	RewriteEngine On
	RewriteCond %{SERVER_NAME} =calc1.ru [OR]
	RewriteCond %{SERVER_NAME} =www.calc1.ru
	RewriteRule ^ https://%{SERVER_NAME}%{REQUEST_URI} [END,NE,R=permanent]

	# Logging
	ErrorLog ${APACHE_LOG_DIR}/calc1.ru_error.log
	CustomLog ${APACHE_LOG_DIR}/calc1.ru_access.log combined
</VirtualHost>

# HTTPS Configuration (port 443) - Reverse Proxy to Docker
<IfModule mod_ssl.c>
	<VirtualHost *:443>
		ServerName calc1.ru
		ServerAlias www.calc1.ru

		# SSL Configuration
		SSLEngine on
		Include /etc/letsencrypt/options-ssl-apache.conf
		SSLCertificateFile /etc/letsencrypt/live/calc1.ru/fullchain.pem
		SSLCertificateKeyFile /etc/letsencrypt/live/calc1.ru/privkey.pem

		# Proxy to Docker container running on port 3000
		ProxyPreserveHost On
		ProxyPass / http://localhost:3000/
		ProxyPassReverse / http://localhost:3000/

		# Forward headers for proper request handling
		RequestHeader set X-Forwarded-Proto "https"
		RequestHeader set X-Forwarded-Port "443"
		RequestHeader set X-Real-IP "%{REMOTE_ADDR}s"

		# Security headers
		Header always set Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"
		Header always set X-Content-Type-Options "nosniff"
		Header always set X-Frame-Options "SAMEORIGIN"
		Header always set X-XSS-Protection "1; mode=block"
		Header always set Referrer-Policy "strict-origin-when-cross-origin"

		# Logging
		ErrorLog ${APACHE_LOG_DIR}/calc1.ru_ssl_error.log
		CustomLog ${APACHE_LOG_DIR}/calc1.ru_ssl_access.log combined

		# LogLevel can be adjusted for debugging
		# LogLevel info
	</VirtualHost>
</IfModule>

